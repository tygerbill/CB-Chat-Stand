<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Stand - Gaming Community Hub</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;
        let displayName = localStorage.getItem('displayName') || null; // Load display name from local storage

        // Function to update the display name on the UI
        function updateDisplayNameUI() {
            const displayNameSpan = document.getElementById('user-id-display');
            if (displayName) {
                displayNameSpan.textContent = `Logged in as: ${displayName}`;
            } else if (userId) {
                displayNameSpan.textContent = `User ID: ${userId.substring(0, 8)}`;
            } else {
                displayNameSpan.textContent = 'User ID: Loading...';
            }
        }

        // Function to handle setting the display name
        function setDisplayName() {
            const nameInput = document.getElementById('name-input');
            const newName = nameInput.value.trim();
            if (newName) {
                displayName = newName;
                localStorage.setItem('displayName', newName); // Save to local storage
                updateDisplayNameUI();
                nameInput.value = ''; // Clear input field
            }
        }


        // Function to initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Sign in anonymously or with custom token
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        updateDisplayNameUI(); // Update UI after user ID is available
                        setupChatAndBBListeners(); // Start listening for data after auth
                    } else {
                        console.log("No user signed in.");
                        userId = null;
                        updateDisplayNameUI(); // Update UI if no user
                    }
                });

                console.log("Firebase initialized and authenticated.");
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('user-id-display').textContent = `Error: ${error.message}`;
            }
        }

        // --- Chat Room Functionality ---
        function setupChatListener() {
            const chatMessagesDiv = document.getElementById('chat-messages');
            const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/chat`);
            const q = query(chatCollectionRef); // No orderBy to avoid index issues, sort client-side

            onSnapshot(q, (snapshot) => {
                chatMessagesDiv.innerHTML = ''; // Clear existing messages
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                // Sort messages by timestamp client-side
                messages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                messages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'bg-gray-700 p-2 rounded-lg mb-2 break-words';
                    // Use displayName if available, otherwise shorten userId
                    const sender = msg.displayName || (msg.userId === userId ? 'You' : msg.userId.substring(0, 8));
                    const time = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString() : 'Just now';
                    // Text colors adjusted for better contrast
                    messageElement.innerHTML = `<p class="text-sm text-blue-300 font-bold">${sender} <span class="text-gray-300 text-xs">(${time})</span>:</p><p class="text-white">${msg.text}</p>`;
                    chatMessagesDiv.appendChild(messageElement);
                });
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
            });
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const messageText = chatInput.value.trim();

            if (messageText && userId) {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/chat`), {
                        userId: userId,
                        displayName: displayName, // Include display name
                        text: messageText,
                        timestamp: serverTimestamp() // Firestore server timestamp
                    });
                    chatInput.value = ''; // Clear input
                } catch (e) {
                    console.error("Error adding document: ", e);
                    // Display user-friendly error
                    document.getElementById('chat-status').textContent = 'Failed to send message.';
                    setTimeout(() => document.getElementById('chat-status').textContent = '', 3000);
                }
            } else if (!userId) {
                document.getElementById('chat-status').textContent = 'Please wait for authentication...';
                setTimeout(() => document.getElementById('chat-status').textContent = '', 3000);
            }
        }

        // --- Bulletin Board Functionality ---
        function setupBulletinBoardListener() {
            const bbPostsDiv = document.getElementById('bb-posts');
            const bbCollectionRef = collection(db, `artifacts/${appId}/public/data/bulletinBoard`);
            const q = query(bbCollectionRef); // No orderBy to avoid index issues, sort client-side

            onSnapshot(q, (snapshot) => {
                bbPostsDiv.innerHTML = ''; // Clear existing posts
                const posts = [];
                snapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });

                // Sort posts by timestamp client-side
                posts.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'bg-gray-700 p-4 rounded-lg mb-4 shadow-md';
                    // Use displayName if available, otherwise shorten userId
                    const author = post.displayName || (post.userId ? post.userId.substring(0, 8) : 'Unknown');
                    const time = post.timestamp ? new Date(post.timestamp.toMillis()).toLocaleString() : 'Just now';
                    // Text colors adjusted for better contrast
                    postElement.innerHTML = `
                        <h3 class="text-xl font-semibold text-purple-300 mb-1 break-words">${post.title}</h3>
                        <p class="text-sm text-blue-100 mb-2 break-words">${post.content}</p>
                        <p class="text-xs text-gray-300">Posted by ${author} on ${time}</p>
                    `;
                    bbPostsDiv.appendChild(postElement);
                });
            });
        }

        async function createPost() {
            const postTitleInput = document.getElementById('post-title');
            const postContentInput = document.getElementById('post-content');
            const title = postTitleInput.value.trim();
            const content = postContentInput.value.trim();

            if (title && content && userId) {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/bulletinBoard`), {
                        userId: userId,
                        displayName: displayName, // Include display name
                        title: title,
                        content: content,
                        timestamp: serverTimestamp() // Firestore server timestamp
                    });
                    postTitleInput.value = ''; // Clear input
                    postContentInput.value = ''; // Clear input
                } catch (e) {
                    console.error("Error adding post: ", e);
                    // Display user-friendly error
                    document.getElementById('bb-status').textContent = 'Failed to create post.';
                    setTimeout(() => document.getElementById('bb-status').textContent = '', 3000);
                }
            } else if (!userId) {
                document.getElementById('bb-status').textContent = 'Please wait for authentication...';
                setTimeout(() => document.getElementById('bb-status').textContent = '', 3000);
            } else {
                document.getElementById('bb-status').textContent = 'Title and content cannot be empty.';
                setTimeout(() => document.getElementById('bb-status').textContent = '', 3000);
            }
        }

        // Setup listeners after Firebase is initialized and authenticated
        function setupChatAndBBListeners() {
            setupChatListener();
            setupBulletinBoardListener();
        }

        // Initialize Firebase when the DOM is fully loaded and attach event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            updateDisplayNameUI(); // Initial UI update based on localStorage

            // Attach event listener for the Send chat message button
            const sendChatBtn = document.getElementById('send-chat-btn');
            if (sendChatBtn) {
                sendChatBtn.addEventListener('click', sendMessage);
            }

            // Attach event listener for the Create Post button
            const createPostBtn = document.getElementById('create-post-btn');
            if (createPostBtn) {
                createPostBtn.addEventListener('click', createPost);
            }

            // Attach event listener for the Set Name button
            const setNameBtn = document.getElementById('set-name-btn');
            if (setNameBtn) {
                setNameBtn.addEventListener('click', setDisplayName);
            }

            // Allow sending chat message with Enter key
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // Allow creating post with Enter key in content field (optional, could also be on title)
            const postContentInput = document.getElementById('post-content');
            if (postContentInput) {
                postContentInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter' && !event.shiftKey) { // Shift+Enter for new line
                        event.preventDefault(); // Prevent default new line
                        createPost();
                    }
                });
            }

            // Allow setting name with Enter key in name input field
            const nameInput = document.getElementById('name-input');
            if (nameInput) {
                nameInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        setDisplayName();
                    }
                });
            }
        });
    </script>

    <style>
        /* Base styles */
        body { @apply bg-gray-900 text-gray-100; }

        /* Container for chat and bulletin board */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem; /* gap-6 */
        }

        @media (min-width: 768px) { /* md breakpoint */
            .grid-container {
                grid-template-columns: 1fr 1fr; /* Two columns on medium screens and up */
            }
        }

        /* Custom scrollbar for better visibility on dark background */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* Darker grey track */
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568; /* Grey thumb */
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Lighter grey on hover */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-gradient-to-r from-green-500 to-blue-600 py-6 shadow-xl">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-2 tracking-tight">
                🎮 The Stand 💬
            </h1>
            <p id="user-id-display" class="text-sm text-green-100 font-mono mt-2">Logged in as: Loading...</p>
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
                <input type="text" id="name-input" placeholder="Set your display name"
                       class="p-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500 text-gray-100 w-full sm:w-auto">
                <button id="set-name-btn"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 w-full sm:w-auto">
                    Set Name
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 md:p-6 lg:p-8">
        <div class="grid-container">

            <!-- Chat Room Section -->
            <section class="bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col h-[500px]">
                <h2 class="text-3xl font-bold text-teal-400 mb-4 pb-2 border-b border-gray-700">Live Chat</h2>
                <div id="chat-messages" class="flex-grow overflow-y-auto bg-gray-900 p-4 rounded-lg mb-4 custom-scrollbar">
                    <!-- Chat messages will be loaded here -->
                    <p class="text-gray-400">Loading messages...</p>
                </div>
                <div class="flex items-center">
                    <input type="text" id="chat-input" placeholder="Type your message..."
                           class="flex-grow p-3 rounded-l-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-100">
                    <button id="send-chat-btn"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-r-lg transition duration-200">
                        Send
                    </button>
                </div>
                <p id="chat-status" class="text-xs text-red-400 mt-2"></p>
            </section>

            <!-- Bulletin Board Section -->
            <section class="bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col h-[500px]">
                <h2 class="text-3xl font-bold text-purple-400 mb-4 pb-2 border-b border-gray-700">Bulletin Board</h2>
                <div id="bb-posts" class="flex-grow overflow-y-auto bg-gray-900 p-4 rounded-lg mb-4 custom-scrollbar">
                    <!-- Bulletin board posts will be loaded here -->
                    <p class="text-gray-400">Loading posts...</p>
                </div>
                <div class="flex flex-col">
                    <input type="text" id="post-title" placeholder="Post Title..."
                           class="p-3 mb-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 text-gray-100">
                    <textarea id="post-content" placeholder="Your post content..." rows="3"
                              class="p-3 mb-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 text-gray-100 resize-none"></textarea>
                    <button id="create-post-btn"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                        Create Post
                    </button>
                </div>
                <p id="bb-status" class="text-xs text-red-400 mt-2"></p>
            </section>

        </div>
    </main>

    <footer class="bg-gray-900 py-6 text-center text-gray-400 text-sm border-t border-gray-700">
        <div class="container mx-auto px-4">
            <p>&copy; 2025 The Stand. All rights reserved.</p>
        </div>
    </footer>

</body>
</html>
